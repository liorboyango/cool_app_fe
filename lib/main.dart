aW1wb3J0ICdkYXJ0OmNvbnZlcnQnOwppbXBvcnQgJ3BhY2thZ2U6Zmx1dHRlci9tYXRlcmlhbC5kYXJ0JzsKaW1wb3J0ICdwYWNrYWdlOmh0dHAvaHR0cC5kYXJ0JyBhcyBodHRwOwppbXBvcnQgJ3BhY2thZ2U6cHJvdmlkZXIvcHJvdmlkZXIuZGFydCc7CgppbXBvcnQgJ3RoZW1lX25vdGlmaWVyLmRhcnQnOwppbXBvcnQgJ3NldHRpbmdzX3NjcmVlbi5kYXJ0JzsKCnZvaWQgbWFpbigpIHsKICBydW5BcHAoCiAgICBDaGFuZ2VOb3RpZmllclByb3ZpZGVyKAogICAgICBjcmVhdGU6IChjb250ZXh0KSBuPT4gVGhlbWVOb3RpZmllcigpLAogICAgICBjaGlsZDogcG9uc3QgTXlBcHAoKSwKICAgICksCiAgKTsKfQoKY2xhc3MgTXlBcHAgZXh0ZW5kcyBTdGF0ZWxlc3dXaWRnZXQgewogIGNvbnN0IE15QXBwKHtzdXBlci5rZXl9KTsKCiAgQEBvdmVycmlkZQogIFdpZGdldCBidWlsZChCdWlsZENvbnRleHQgY29udGV4dCkgewogICAgcmV0dXJuIENvbnN1bWVyPFRoZW1lTm90aWZpZXI+KAogICAgICBidWlsZGVyOiAoY29udGV4dCwgdGhlbWVOb3RpZmllciwgY2hpbGQpIHsKICAgICAgICByZXR1cm4gTWF0ZXJpYWxBcHAoCiAgICAgICAgICB0aXRsZTogJ0Nvb2xlc3QgQXBwIEV2ZXInLAogICAgICAgICAgdGhlbWU6IFRoZW1lRGF0YSgKICAgICAgICAgICAgY29sb3JTY2hlbWU6IENvbG9yU2NoZW1lLmZyb21TZWVkKHNlZWRDb2xvcjogQ29sb3JzLmRlZXBQdXJwbGUpLAogICAgICAgICAgICB1c2VN jammer3OiB0cnVlLAogICAgICAgICAgKSwKICAgICAgICAgIGRhcmtUaGVtZTogVGhlbWVEYXRhKAogICAgICAgICAgICBjb2xvclNjaGVtZTogQ29sb3JTY2hlbWUuZnJvbVNlZWQoc2VlZENvbG9yOiBDb2xvcnMuZGVlcFB1cnBsZSwgYnJpZ2h0bmVzczogQnJpZ2h0bmVzcy5kYXJrKSwKICAgICAgICAgICAgdXNlTWF0ZXJpYWwzOiB0cnVlLAogICAgICAgICAgKSwKICAgICAgICAgIHRoZW1lTW9kZTogdGhlbWVOb3RpZmllci50aGVtZU1vZGUsCiAgICAgICAgICBob21lOiBjb25zdCBNeUhvbWVQYWdlKHRpdGxlOiAnQ29vbGVzdCBNYWluIFNjcmVlbiBFdmVyIScpLAogICAgICAgICk7CiAgICAgIH0sCiAgICk7CiAgfQp9CgpjbGFzcyBNeUhvbWVQYWdlIGV4dGVuZHMgU3RhdGVmdWxXaWRnZXQgewogIGNvbnN0IE15SG9tZVBhZ2Uoe3N1cGVyLmtleSwgcmVxdWlyZWQgdGhpcy50aXRsZX0pOwoKICBmaW5hbCBTdHJpbmcgdGl0bGU7CgogIEBPdmVycmlkZQogIFN0YXRlPE15SG9tZVBhZ2U+IGNyZWF0ZVN0YXRlKCkgPT4gX015SG9tZVBhZ2VTdGF0ZSgpOwp9CgpjbGFzcyBfTXlIb21lUGFnZVN0YXRlIGV4dGVuZHMgU3RhdGU8TXlIb21lUGFnZT4gewogIFN0cmluZyBfc3RhdHVzID0gJ0ZldGNoaW5nLi4uJzsKICBMaXN0PGR5bmFtaWM+IF91c2VycyA9IFtdOwogIFN0cmluZyBfc2VhcmNoUXVlcnkgPSAnJzsKICBTdHJpbmc/IF9zZWxlY3RlZFJvbGU7CiAgTGlzdDxkeW5hbWljPiBfZGlzcGxheWVkVXNlcnMgPSBbXTsKICBsYXRlIFRleHRFZGl0aW5nQ29udHJvbGxlciBfc2VhcmNoQ29udHJvbGxlcjsKICBTdHJpbmc/IF9zZWxlY3RlZFVzZXJOYW1lOwoKICBAT3ZlcnJpZGUKICB2b2lkIGluaXRTdGF0ZSgpIHsKICAgIHN1cGVyLmluaXRTdGF0ZSgpOwogICAgX3NlYXJjaENvbnRyb2xsZXIgPSBUZXh0RWRpdGluZ0NvbnRyb2xsZXIoKTsKICAgIF9zZWFyY2hDb250cm9sbGVyLmFkZExpc3RlbmVyKF91cGRhdGVTZWFyY2hRdWVyeSk7CiAgICBfZmV0Y2hTZXJ2ZXJTdGF0dXMoKTsKICAgIF9mZXRjaFVzZXJzKCk7CiAgfQoKICB2b2lkIF91cGRhdGVTZWFyY2hRdWVyeSgpIHsKICAgIF9zZWFyY2hRdWVyeSA9IF9zZWFyY2hDb250cm9sbGVyLnRleHQ7CiAgICBfdXBkYXRlRGlzcGxheWVkVXNlcnMoKTsKICB9CgogIEZ1dHVyZTx2b2lkPiBfZmV0Y2hTZXJ2ZXJTdGF0dXMoKSBhc3luYyB7CiAgICB0cnkgewogICAgICBmaW5hbCByZXNwb25zZSA9IGF3YWl0IGh0dHAuZ2V0KAogICAgICAgIFVyaS5wYXJzZSgnaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS9zdGF0dXMnKSwKICAgICAgKTsKCiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID09IDIwMCkgewogICAgICAgIGZpbmFsIGRhdGEgPSBqc29uLmRlY29kZShyZXNwb25zZS5ib2R5KTsKICAgICAgICBzZXR TdGF0ZSgoKSB7CiAgICAgICAgICBfc3RhdHVzID0gJ1N0YXR1czogJHtkYXRhWydzdGF0dXMnXX0sIFRpbWU6ICR7ZGF0YVsndGltZXN0YW1wJ119JzsgCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0U3RhdGUoKSB7CiAgICAgICAgICBfc3RhdHVzID0gJ1NlcnZlciBlcnJvcjogJHtyZXNwb25zZS5zdGF0dXNDb2RlfSc7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgc2V0U3RhdGUoKSB7CiAgICAgICAgX3N0YXR1cyA9ICdFcnJvcjogJGUnOwogICAgICB9KTsKICAgIH0KICB9CgogIEZ1dHVyZTx2b2lkPiBfZmV0Y2hVc2VycygpIGFzeW5jIHsKICAgIHRyeSB7CiAgICAgIGZpbmFsIHJlc3BvbnNlID0gYXdhaXQgaHR0cC5nZXQoVXJpLnBhcnNlKCdodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL3VzZXJzJykpOwogICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PSAyMDApIHsKICAgICAgICBmaW5hbCBMaXN0PGR5bmFtaWM+IGRhdGEgPSBqc29uLmRlY29kZShyZXNwb25zZS5ib2R5KTsKICAgICAgICBzZXRTdGF0ZSgoKSB7CiAgICAgICAgICBfdXNlcnMgPSBkYXRhOwogICAgICAgICAgX3VwZGF0ZURpc3BsYXllZFVzZXJzKCk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0U3RhdGUoKSB7CiAgICAgICAgICBfdXNlcnMgPSBbXTsKICAgICAgICAgIF9kaXNwbGF5ZWRVc2VycyA9IFtdOwogICAgICAgIH0pOwogICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHNldFN0YXRlKCgpIHsKICAgICAgICBfdXNlcnMgPSBbXTsKICAgICAgICBfZGlzcGxheWVkVXNlcnMgPSBbXTsKICAgICAgfSk7CiAgICB9CiAgfQoKICB2b2lkIF91cGRhdGVEaXNwbGF5ZWRVc2VycygpIHsKICAgIHZhciBmaWx0ZXJlZCA9IExpc3QuZHluYW1pYy5mcm9tKF91c2Vycyk7CiAgICBpZiAoX3NlbGVjdGVkUm9sZSAhPSBudWxsKSB7CiAgICAgIGZpbHRlcmVkID0gZmlsdGVyZWQud2hlcmUoKHV8IHUgWydyb2xlJ10gPT0gX3NlbGVjdGVkUm9sZSkudG9MaXN0KCk7CiAgICB9CiAgICBpZiAoX3NlYXJjaFF1ZXJ5LmlzTm90RW1wdHkpIHsKICAgICAgZmlsdGVyZWQgPSBmaWx0ZXJlZC53aGVyZSgodSkgPT4gKHVbJ25hbWUnXSBhcyBTdHJpbmcpLnRvTG93ZXJDYXNlKCkuY29udGFpbnMoX3NlYXJjaFF1ZXJ5LnRvTG93ZXJDYXNlKCkpKS50b0xpc3QoKTsKICAgIH0KICAgIGZpbHRlcmVkLnNvcnQoKGEsIGIpIHsKICAgICAgZmluYWwgcm9sZUNvbXAgPSAoYVsncm9sZSddIGFzIFN0cmluZykub21wYXJlVG8oYlsncm9sZSddKTsKICAgICAgaWYgKHJvbGVDb21wICE9IDApIHJldHVybiByb2xlQ29tcDsKICAgICAgcmV0dXJuIChhWyduYW1lJ10gYXMgU3RyaW5nKS5jb21wYXJlVG8oYlsubmFtZSddKTsKICAgIH0pOwogICAgc2V0U3RhdGUoKSB7CiAgICAgIF9kaXNwbGF5ZWRVc2VycyA9IGZpbHRlcmVkOwogICAgfSk7CiAgfQoKICBAT3ZlcnJpZGUKICBXaWRnZXQgYnVpbGQoQnVpbGRDb250ZXh0IGNvbnRleHQpIHsKICAgIGZpbmFsIHRoZW1lID0gVGhlbWUub2YoY29udGV4dCk7CiAgICBmaW5hbCBTZXQ8U3RyaW5nPiByb2xlcyA9IF91c2Vycy5tYXAoKHV8IHVbJ3JvbGUnXSBhcyBTdHJpbmcpLnRvU2V0KCk7CiAgICByZXR1cm4gU2NhZmZvbGQoCiAgICAgIGFwcEJhcjogQXBwQmFyKAogICAgICAgIGJhY2tncm91bmRDb2xvcjogdGhlbWUuY29sb3JTY2hlbWUuaW52ZXJzZVByaW1hcnksCiAgICAgICAgdGl0bGU6IFRleHQod2lkZ2V0LnRpdGxlKSwKICAgICAgICBhY3Rpb25zOiBbCiAgICAgICAgICBJY29uQnV0dG9uKAogICAgICAgICAgICBpY29uOiBjb25zdCBJY29uKEljb25zLnNldHRpbmdzKSwKICAgICAgICAgICAgb25QcmVzc2VkOiAoKSB7CiAgICAgICAgICAgICAgTmF2aWdhdG9yLm9mKGNvbnRleHQpLnB1c2goCiAgICAgICAgICAgICAgICBNYXRlcmlhbFBhZ2VSb3V0ZSgKICAgICAgICAgICAgICAgICAgYnVpbGRlcjogKGNvbnRleHQpID0+IGNvbnN0IFNldHRpbmdzU2NyZWVuKCksCiAgICAgICAgICAgICAgICk8ICAgICAgICAgICAgICApOwogICAgICAgICAgfSwKICAgICAgICAgICk8ICAgICAgICBdLAogICAgICk8ICAgICAgYm9keTogTGlzdFZpZXcoCiAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgIENlbnRlcihjaGlsZDogVGV4dChfc3RhdHVzLCBzdHlsZTogdGhlbWUudGV4dFRoZW1lLmhlYWRsaW5lU21hbGwpKSwKICAgICAgICAgIFBhZGRpbmc8ICAgICAgICAgICBwYWRkaW5nOiBjb25zdCBFZ2dlSW5zZXQub2YoMTYuMCksCiAgICAgICAgICAgY2hpbGQ6IFJvdwogICAgICAgICAgIChtYWluQXhpc0FsaWdubWVudDogTWFpbkF4aXNBbGlnbm1lbnQuY2VudGVyLAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIEV2ZWxhdGVkQnV0dG9uKG9uUHJlc3NlZDoggX2ZldGNoU2VydmVyU3RhdHVzLCBjaGlsZDogY29uc3QgVGV4dCgnUmVmcmVzaCBTdGF0dXMnKSksCiAgICAgICAgICAgICAgY29uc3QgU2l6ZWRCb3god2lkdGg6IDE2LjApLAogICAgICAgICAgICAgIEV2ZWxhdGVkQnV0dG9uKG9uUHJlc3NlZDoggX2ZldGNoVXNlcnMsIGNoaWxkOiBjb25zdCBUZXh0KCdSZWZyZXNoIFVzZXJzJykpLAogICAgICAgICAgICBdLAogICAgICAgICAgKSwKICAgICAgICAgKSwKICAgICAgICAgIFBhZGRpbmc8ICAgICAgICAgICBwYWRkaW5nOiBjb25zdCBFZ2dlSW5zZXQuc3ltbWV0cmljKGhvcml6b250YWw6IDE2LjAsIHZlcnRpY2FsOiA4LjApLAogICAgICAgICAgIGNoaWxkOiBUZXh0RmllbGQoCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IF9zZWFyY2hDb250cm9sbGVyLAogICAgICAgICAgICBkZWNvcmF0aW9uOiBJbnB1dERlY29yYXRpb24oCiAgICAgICAgICAgICAgbGFiZWxUZXh0OiAnU2VhcmNoIGJ5IG5hbWUnLAogICAgICAgICAgICAgIGJvcmRlcjogT3V0bGluZUlucHV0Qm9yZGVyKCksCiAgICAgICAgICAgICAgc3VmZml4SWNvbjogX3NlYXJjaENvbnRyb2xsZXIudGV4dC5pc05vdEVtcHR5CiAgICAgICAgICAgICAgICAgID8gSWNvbkJ1dHRvbigKICAgICAgICAgICAgICAgICAgICAgIGljb246IGNvbnN0IEljb24oSWNvbnMuY2xlYXIpLAogICAgICAgICAgICAgICAgICAgICAgb25QcmVzc2VkOiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9zZWFyY2hDb250cm9sbGVyLmNsZWFyKCk7CiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgKSkKICAgICAgICAgICAgICAgICAgICAgIDogbnVsbCwKICAgICAgICAgICAgKSwKICAgICAgICAgICk8ICAgICAgICApLAogICAgICAgICAgUGFkZGluZyAoCiAgICAgICAgICAgcGFkZGluZzogY29uc3QgRWRnZUluc2V0cy5zeW1tZXRyaWMoaG9yaXpvbnRhbDogMTYuMCwgdmVydGljYWw6IDguMCksCiAgICAgICAgICBjaGlsZDoge0Ryb3Bkb3duQnV0dG9uPFN0cmluZz8+KAogICAgICAgICAgICB2YWx1ZTogX3NlbGVjdGVkUm9sZSwKICAgICAgICAgICAgaGludDogY29uc3QgVGV4dCgnRmlsdGVyIGJ5IHJvbGUnKSwKICAgICAgICAgICAgaXNFeHBhbmRlZDogdHJ1ZSwKICAgICAgICAgICAgaXRlbXM6IDxEcm9wZG93bk1lbnVJdGVtPFN0cmluZz8+PlsKICAgICAgICAgICAgICBjb25zdCBEcm9wZG93bk1lbnVJdGVtPFN0cmluZz8+KAogICAgICAgICAgICAgICAgdmFsdWU6IG51bGwsCiAgICAgICAgICAgICAgICBjaGlsZDogVGV4dCgnQWxsJyksCiAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgXSArIHJvbGVzLm1hcDxEcm9wZG93bk1lbnVJdGVtPFN0cmluZz8+PigoU3RyaW5nIHJvbGUpIHsKICAgICAgICAgICAgICByZXR1cm4gRHJvcGRvd25NZW51SXRlbTxTdHJpbmc/PlsKICAgICAgICAgICAgICAgIHZhbHVlOiByb2xlLAogICAgICAgICAgICAgICAgY2hpbGQ6IFRleHQocm9sZSksCiAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIH0pLnRvTGlzdCgpLAogICAgICAgICAgICBvbkNoYW5nZWQ6IChTdHJpbmc/IG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgc2V0U3RhdGUoKSB7CiAgICAgICAgICAgICAgICBfc2VsZWN0ZWRSb2xlID0gbmV3VmFsdWU7CiAgICAgICAgICAgICAgICBfdXBkYXRlRGlzcGxheWVkVXNlcnMoKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICk8ICAgICAgICApLAogICAgICAgICAgQ29udGFpbmVyKAogICAgICAgICAgICBwYWRkaW5nOiBjb25zdCBFZ2dlSW5zZXQub2YoMTYuMCksCiAgICAgICAgICAgIGNoaWxkOiBUZXh0KCdVc2VyczonLCBzdHlsZTogdGhlbWUudGV4dFRoZW1lLmhlYWRsaW5lU21hbGwpLAogICAgICAgICAgKSwKICAgICAgICAgIExpc3RWaWV3LmJ1aWxkZXIoCiAgICAgICAgICAgIHNocmlua1dyYXA6IHRydWUsCiAgICAgICAgICAgIHBoeXNpY3M6IGNvbnN0IE5ldmVyU2Nyb2xsYWJsZVNjcm9sbFBoeXNpY3MoKSwKICAgICAgICAgICAgaXRlbUNvdW50OiBfZGlzcGxheWVkVXNlcnMubGVuZ3RoLAogICAgICAgICAgICBpdGVtQnVpbGRlcjogKGNvbnRleHQsIGluZGV4KSB7CiAgICAgICAgICAgICAgZmluYWwgdXNlciA9IF9kaXNwbGF5ZWRVc2Vyc1tpbmRleF07CiAgICAgICAgICAgICAgZmluYWwgaXNTZWxlY3RlZCA9IF9zZWxlY3RlZFVzZXJOYW1lID09IHVzZXJbJ25hbWUnXTsKICAgICAgICAgICAgICByZXR1cm4gTGlzdFRpbGUoCiAgICAgICAgICAgICAgICBvblRhcDogKCkgewogICAgICAgICAgICAgICAgICBzZXRTdGF0ZSgoKSB7CiAgICAgICAgICAgICAgICAgICAgX3NlbGVjdGVkVXNlck5hbWUgPSBpc1NlbGVjdGVkID8gbnVsbCA6IHVzZXJbJ25hbWUnXTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdGl0bGU6IFRleHQoCiAgICAgICAgICAgICAgICAgIHVzZXJbJ25hbWUnXSwKICAgICAgICAgICAgICAgICAgc3R5bGU6IFRleHRTdHlsZSgKICAgICAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiBpc1NlbGVjdGVkID8gRm9udFdlaWdodC5ib2xkIDogRm9udFdlaWdodC5ub3JtYWwsCiAgICAgICAgICAgICAgICAgICAgZm9udFNpemU6IGlzU2VsZWN0ZWQgPyAyMC4wIDogbnVsbCwKICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICk8ICAgICAgICAgICAgICBzdWJ0aXRsZTogVGV4dCgnUm9sZTogJHt1c2VyWydyb2xlJ319JyksCiAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgfSwKICAgICAgICAgICk8ICAgICAgICBdLAogICAgICk8ICAgICk7CiAgfQoKICBAT3ZlcnJpZGUKICB2b2lkIGRpc3Bvc2UoKSB7CiAgICBfc2VhcmNoQ29udHJvbGxlci5kaXNwb3NlKCk7CiAgICBzdXBlci5kaXNwb3NlKCk7CiAgfQp9Cg==